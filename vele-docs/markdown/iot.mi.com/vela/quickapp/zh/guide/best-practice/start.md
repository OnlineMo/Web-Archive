::: {#app server-rendered="true"}
::: theme-container
::: navbar
::: sidebar-button
![](data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGFyaWEtaGlkZGVuPSJ0cnVlIiByb2xlPSJpbWciIHZpZXdib3g9IjAgMCA0NDggNTEyIiBjbGFzcz0iaWNvbiI+PHBhdGggZmlsbD0iY3VycmVudENvbG9yIiBkPSJNNDM2IDEyNEgxMmMtNi42MjcgMC0xMi01LjM3My0xMi0xMlY4MGMwLTYuNjI3IDUuMzczLTEyIDEyLTEyaDQyNGM2LjYyNyAwIDEyIDUuMzczIDEyIDEydjMyYzAgNi42MjctNS4zNzMgMTItMTIgMTJ6bTAgMTYwSDEyYy02LjYyNyAwLTEyLTUuMzczLTEyLTEydi0zMmMwLTYuNjI3IDUuMzczLTEyIDEyLTEyaDQyNGM2LjYyNyAwIDEyIDUuMzczIDEyIDEydjMyYzAgNi42MjctNS4zNzMgMTItMTIgMTJ6bTAgMTYwSDEyYy02LjYyNyAwLTEyLTUuMzczLTEyLTEydi0zMmMwLTYuNjI3IDUuMzczLTEyIDEyLTEyaDQyNGM2LjYyNyAwIDEyIDUuMzczIDEyIDEydjMyYzAgNi42MjctNS4zNzMgMTItMTIgMTJ6Ij48L3BhdGg+PC9zdmc+){.icon}
:::

[![Xiaomi Vela JS 应用开发文档](../../../logo.png){.logo} [Xiaomi Vela
JS 应用开发文档]{.site-name
.can-hide}](https://iot.mi.com/vela/quickapp/){.home-link
.router-link-active}

::: links
::: search-box
:::

::: nav-item
[教程](../version/APILevel4.html){.nav-link .router-link-active}
:::

::: nav-item
[组件](../../components/index.html){.nav-link}
:::

::: nav-item
[JS接口](../../features/index.html){.nav-link}
:::

::: nav-item
[编程示例](../../samples/index.html){.nav-link}
:::

::: nav-item
[工具](../../tools/index.html){.nav-link}
:::
:::
:::

::: sidebar-mask
:::

::: nav-item
[教程](../version/APILevel4.html){.nav-link .router-link-active}
:::

::: nav-item
[组件](../../components/index.html){.nav-link}
:::

::: nav-item
[JS接口](../../features/index.html){.nav-link}
:::

::: nav-item
[编程示例](../../samples/index.html){.nav-link}
:::

::: nav-item
[工具](../../tools/index.html){.nav-link}
:::

-   ::: {.section .sidebar-group .depth-0}
    [快速入门](https://iot.mi.com/vela/quickapp/zh/guide/start){.sidebar-heading
    .clickable}
    -   [安装环境](../start/use-ide.html){.sidebar-link}
    -   [项目结构](../start/project-overview.html){.sidebar-link}
    -   [编写页面UI](../start/user-interface.html){.sidebar-link}
    -   [添加交互](../start/add-interactivity.html){.sidebar-link}
    -   [数据获取](../start/data-fetch.html){.sidebar-link}
    -   [编译参数](../start/toolkit-params.html){.sidebar-link}
    :::

-   ::: {.section .sidebar-group .depth-0}
    [基础功能](../framework/index.html){.sidebar-heading .clickable}
    -   [项目结构](../framework/project-structure.html){.sidebar-link}

    -   [项目配置](../framework/manifest.html){.sidebar-link}

    -   [UX 文件](../framework/ux.html){.sidebar-link}

    -   ::: {.section .sidebar-group .collapsable .is-sub-group .depth-1}
        [模板语法 []{.arrow
        .right}](../framework/template/index.html){.sidebar-heading
        .clickable}
        :::

    -   ::: {.section .sidebar-group .collapsable .is-sub-group .depth-1}
        [样式语法 []{.arrow
        .right}](../framework/style/index.html){.sidebar-heading
        .clickable}
        :::

    -   ::: {.section .sidebar-group .collapsable .is-sub-group .depth-1}
        [脚本语法 []{.arrow
        .right}](../framework/script/index.html){.sidebar-heading
        .clickable}
        :::

    -   [页面切换](../framework/page-switch.html){.sidebar-link}
    :::

-   ::: {.section .sidebar-group .depth-0}
    [进阶功能](../framework/other/index.html){.sidebar-heading
    .clickable}
    -   [多语言覆盖](../framework/other/i18n.html){.sidebar-link}

    -   [后台运行](../framework/other/background-running.html){.sidebar-link}

    -   [hap 链接](../framework/other/hap-schema.html){.sidebar-link}

    -   [页面启动模式](../framework/other/launch-mode.html){.sidebar-link}

    -   ::: {.section .sidebar-group .is-sub-group .depth-1}
        [多屏适配](../multi-screens/index.html){.sidebar-heading
        .clickable}
        -   [适配规范](../multi-screens/specs.html){.sidebar-link}
        -   [代码示例](../multi-screens/samples.html){.sidebar-link}
        -   [条件编译](../multi-screens/conditional-compilation.html){.sidebar-link}
        :::
    :::

-   ::: {.section .sidebar-group .depth-0}
    [开发者物料](../developer-materials/index.html){.sidebar-heading
    .clickable}
    -   [拓展组件](../developer-materials/extension-components.html){.sidebar-link}
    :::

-   ::: {.section .sidebar-group .depth-0}
    [设计指南](../design/index.html){.sidebar-heading .clickable}
    -   [多屏设计](../design/multi-screens.html){.sidebar-link}
    :::

-   ::: {.section .sidebar-group .depth-0}
    [最佳实践](index.html){.sidebar-heading .clickable
    .router-link-active .open}
    -   [内存优化](memory.html){.sidebar-link}
    -   [常用业务优化](business.html){.sidebar-link}
    -   [启动时延优化](start.html){.active .sidebar-link
        aria-current="page"}
    :::

-   ::: {.section .sidebar-group .depth-0}
    [发布](../publish/index.html){.sidebar-heading .clickable}
    -   [验收标准](../publish/acceptance-criteria.html){.sidebar-link}
    :::

-   ::: {.section .sidebar-group .depth-0}
    [版本说明](../version/index.html){.sidebar-heading .clickable}
    -   [APILevel2](https://iot.mi.com/vela/quickapp/zh/guide/version/APILevel2.html){.sidebar-link}
    -   [APILevel3](https://iot.mi.com/vela/quickapp/zh/guide/version/APILevel3.html){.sidebar-link}
    -   [APILevel4](https://iot.mi.com/vela/quickapp/zh/guide/version/APILevel4.html){.sidebar-link}
    :::

-   ::: {.section .sidebar-group .depth-0}
    其他

    -   [常见问题](../other/faq.html){.sidebar-link}
    -   [注意事项](../other/tips.html){.sidebar-link}
    :::

::: {.page role="main"}
::: {.theme-default-content .content__default}
# [\#](start.html#启动时延优化){.header-anchor} 启动时延优化

## [\#](start.html#避免settimeout延迟){.header-anchor} 避免setTimeout延迟

logo页如非必要，在执行页面跳转时，不要增加setTimeout延迟跳转。如果是需要等待异步结果返回，例如获取storage后决定跳转的下一个页面，建议将异步方法封装成同步，使用await，等待结果返回后立即执行跳转。以storage为例：

::: {.language-js .extra-class}
``` language-js
// ❌不推荐写法
onInit(){
  this.checkifHome()
  setTimeout(() => {
    if(!this.ifHome){
      router.push({uri:'pages/home'})
    }
  },1000)
}
checkifHome(){
  const that = this 
  storage.get({
    key: 'ifHome',
    success: function(data) {
      that.ifHome = data
    },
    fail: function(data, code) {
      console.log(`handling fail, code = ${code}`)
    }
  })
}
```
:::

::: {.language-js .extra-class}
``` language-js
// ✅推荐写法一
onInit(){
  storage.get({
    key: 'ifHome',
    success: function(data) {
      if(!data){
        router.push({uri:'pages/home'})
      }
    },
    fail: function(data, code) {
      console.log(`handling fail, code = ${code}`)
    }
  })
}
```
:::

::: {.language-js .extra-class}
``` language-js
// ✅推荐写法二
async onInit(){
  const ifHome = await checkifHome()
  if(!ifHome){
    router.push({uri:'pages/home'})
  }
}
checkifHome(){
  return new Promise((resolve, reject) => {
    storage.get({
      key: 'ifHome',
      success: function(data) {
        resolve(data) 
      },
      fail: function(data, code) {
        console.log(`handling fail, code = ${code}`)
        reject(code)
      }
    })
  })
}
```
:::

::: {.language-js .extra-class}
``` language-js
// ✅推荐写法三
//可统一封装promise.js,方便其他异步接口复用
export function promisify(fn) {
  if (typeof fn !== 'function') {
    throw Error('[promisify] the type of `fn` should be function');
  }

  return (opts={}) => {
    let { success, fail, complete, ...args } = opts;

    if (typeof success === 'function' || typeof fail === 'function' || typeof complete === 'function') {
      console.warn('[promisify] [WARN] The `success`, `fail` and `complete` callback will be ignored');
    }

    return new Promise((resolve, reject) => {
      try {
        fn({
          ...args,
          success: data => resolve(data),
          fail: (data, code) => {
            let err = new Error(data);
            err.code = code;
            reject(err);
          }
        });
      } catch (error) {
        reject(error)
      }
    })
  }
}

//统一封装storage方法
import storage from '@system.storage';
import {promisify} from './promise';

const _get = promisify(storage.get);
const _set = promisify(storage.set);
const _clear = promisify(storage.clear);
const _delete = promisify(storage.delete);
export default {
  getItem(key) {
    return _get({key});
  },

  setItem(key, value) {
    return _set({key, value});
  },

  deleteItem(key) {
    return _delete({key});
  },

  clear() {
    return _clear();
  },
}

//logo.ux
async onInit(){
   const ifHome = await storage.getItem('ifHome')
  if(!ifHome){
     router.push({uri:'pages/home'})
  }
}
```
:::

## [\#](start.html#首页数据缓存){.header-anchor} 首页数据缓存

首页数据如果二次进入，需要再次展示的，可以考虑在应用（或首页）退出时增加上缓存，下次进入从logo页读取缓存后将数据存储在全局，首页page在onInit时直接读取，然后同时发起异步请求进行更新即可；

## [\#](start.html#logo页避免http请求){.header-anchor} logo页避免http请求

建议不要在logo页引入http请求，尽可能放到首页执行，防止弱网或者无网情况阻塞页面跳转；

## [\#](start.html#ui先行){.header-anchor} UI先行

如音乐类应用，进入应用建议默认状态为不播放，可以UI先行，如果歌曲信息获取成功立即展示，无需等到audio资源加载完成展示；

## [\#](start.html#隐私页信息使用静态数据){.header-anchor} 隐私页信息使用静态数据

隐私页的数据代码里使用静态的数据，不用动态获取。需要展示长文本的，可以通过二维码扫码查看，二维码直接本地写死一个h5链接，不要通过接口去获取；

## [\#](start.html#减少从console打印){.header-anchor} 减少从console打印

尽可能减少console打印，特别是长日志，很影响性能，避免很长的（\>10行）console打印，尽可能减少json对象的打印，如果是debug期间需要打印日志，建议使用console.debug，并且配置quickapp.config.js（具体配置如下），在打release包的时候过滤掉console.debug的日志；

::: {.language-js .extra-class}
``` language-js
const TerserPlugin = require("terser-webpack-plugin")
const webpack = require("webpack")

module.exports = {
  postHook: (config) => {
    if (config.mode === "production") {
      config.optimization.minimize = true
      config.optimization.minimizer = [
        new TerserPlugin({
          terserOptions: {
            compress: {
              pure_funcs: ["console.debug"]
            }
          }
        })
      ]
    }
  }
}
```
:::

## [\#](start.html#图片缓存-裁剪){.header-anchor} 图片缓存/裁剪 {#图片缓存-裁剪}

如果有较大的（\>100kb）动态图片，建议首次加载增加loading页，下载并缓存到本地，后续通过internal://files/XXX.png加载（重要：一般非必要不建议引入在线大图，引入的大图尺寸也不要超过屏幕尺寸，且大小不超过200kb，尽量使用本地图片代替在线图片，或者在线图片里支持resize-尺寸裁剪）

::: {.language-js .extra-class}
``` language-js
//login.ux
export function downloadFile(url) {// 下载图片
  return new Promise((resolve, reject) => {
    if(!url){
      resolve('')
    }
    request.download({
      url,
      success: function (ret) {
        const token = ret.token
        request.onDownloadComplete({
          token: token,
          success: function (ret) {
            console.info(`### request.download ### ret`,ret)
            resolve(ret.uri)
          },
          fail: function (msg, code) {
            console.info(`### request.onDownloadComplete ### ${code}: ${msg}`)
            resolve(null)
          }
        })
      }
    })
  })
}
const formUrl = 'http://XXX.cdn.homeBg.png'
downloadFile(formUrl).then(url => {
  global.homeBgUrl = url; //url => 'internal://files/homeBg.png'
})
 
//home.ux
<image class="w-466 h-466" src="{{bgImage}}" alt="../../common/images/homeBg.png"></image>
//....
  computed:{
    bgImage() {
      const img =  global.homeBgUrl || 'http://XXX.cdn.homeBg.png'
      return img
    }
  }
//....
 
 //logo页
 global.homeBgUrl = await storage.getItem('homeBgUrl')
 
 //根据条件变化，及时进行图片清理
 logoOut(){
   file.delete({
    uri:global.homeBgUrl,
    success: function(data) {
      console.info(`###delFile sucess ${data}`)
      resolve(true)
    },
    fail: function(data, code) {
      resolve(false)
      console.log(`###delFile fail, code = ${code}`)
    }
  })
}
```
:::

## [\#](start.html#通信类应用通信之前使用diagnosis方法判断连接状态){.header-anchor} 通信类应用通信之前使用diagnosis方法判断连接状态

使用interconnect实现手表app和手机app的通信时，摒弃之前的轮询调用getApkStatus方法，改用新api
[diagnosis](../../features/network/interconnect.html#connect-diagnosis-object)

::: {.language-js .extra-class}
``` language-js
data: {
   status: '',
   connectNum: 3,
   conn: null
},
onInit() {
   this.conn = interconnect.instance();
   this.connectStatus();
}, 
```
:::

::: {.language-js .extra-class}
``` language-js
// ❌ 不推荐写法
connectStatus() {
  let status = this.conn.getApkStatus();
  if (status === 'CONNECTED' || this.connectNum === 0){
    this.status = status;
    // do something
  } else if (this.connectNum > 0) {
    this.connectNum --;
    setTimeout(() => {
      this.connectStatus()
    },500)
  }
}
```
:::

::: {.language-js .extra-class}
``` language-js
// ✅推荐写法
connectStatus() {
  this.conn.diagnosis({
    success: (data) => {
      console.log(`handling success, status= ${data.status}`)
      // do something
    },
    fail: (data,code) => {
      console.log(`handling fail, code = ${code}`)
      // do something
    }
  })
}  
```
:::

## [\#](start.html#使用interconnect传输多条数据){.header-anchor} 使用interconnect传输多条数据

手表app向手机app传输多条数据时，若传输数量不大，建议直接一次性发送，无需增加延迟发送

::: {.language-js .extra-class}
``` language-js
// ❌不推荐写法
sendMsg(list) {
  for (let x in list) { 
    setTimeout(() => {
      this.conn.send({
        data: list[x],
        success: ()=>{ },
        fail: (data: {data, code})=> { }
      })
    },x*500) 
  }
}
```
:::

::: {.language-js .extra-class}
``` language-js
// ✅推荐写法
sendMsg(list) {
  for (let x in list) {            
    this.conn.send({
      data: list[x],
      success: ()=>{ },
      fail: (data: {data, code})=> { }
    })
  }
}
```
:::
:::

::: page-nav
[ ← [常用业务优化](business.html){.prev} ]{.prev} [
[验收标准](../publish/acceptance-criteria.html) → ]{.next}
:::
:::

::: toc
::: on-this-page
快速导航
:::

::: {.vuepress-toc-item .vuepress-toc-h2 .active}
[避免setTimeout延迟](start.html#避免settimeout延迟 "避免setTimeout延迟")
:::

::: {.vuepress-toc-item .vuepress-toc-h2}
[首页数据缓存](start.html#首页数据缓存 "首页数据缓存")
:::

::: {.vuepress-toc-item .vuepress-toc-h2}
[logo页避免http请求](start.html#logo页避免http请求 "logo页避免http请求")
:::

::: {.vuepress-toc-item .vuepress-toc-h2}
[UI先行](start.html#ui先行 "UI先行")
:::

::: {.vuepress-toc-item .vuepress-toc-h2}
[隐私页信息使用静态数据](start.html#隐私页信息使用静态数据 "隐私页信息使用静态数据")
:::

::: {.vuepress-toc-item .vuepress-toc-h2}
[减少从console打印](start.html#减少从console打印 "减少从console打印")
:::

::: {.vuepress-toc-item .vuepress-toc-h2}
[图片缓存/裁剪](start.html#图片缓存-裁剪 "图片缓存/裁剪")
:::

::: {.vuepress-toc-item .vuepress-toc-h2}
[通信类应用通信之前使用diagnosis方法判断连接状态](start.html#通信类应用通信之前使用diagnosis方法判断连接状态 "通信类应用通信之前使用diagnosis方法判断连接状态")
:::

::: {.vuepress-toc-item .vuepress-toc-h2}
[使用interconnect传输多条数据](start.html#使用interconnect传输多条数据 "使用interconnect传输多条数据")
:::
:::
:::

::: global-ui
:::
:::
